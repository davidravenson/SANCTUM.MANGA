<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SANCTUM ‚Äî Reader</title>

  <style>
    :root{
      --v: "v0.30.7";
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);

      --bg: url("./media/ui/manga_paper_bg.png");
      --shadow: 0 16px 40px rgba(0,0,0,.35);

      --dock-overlap: -78px;

      --player-expanded-w: min(96vw, 720px);
      --player-expanded-h: 190px;

      /* Breite der linken SC-Zone (Play + Artwork) */
      --sc-left-mask-w: 96px;
    }

    html, body{
      height:100%;
      margin:0;
      background:#000;
      color:#fff;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-tap-highlight-color: transparent;
      overflow-x:hidden;
    }

    body{
      background-image: var(--bg);
      background-size: cover;
      background-position: center top;
      background-repeat: no-repeat;
      background-attachment: fixed;
      overscroll-behavior: none;
      touch-action: pan-y;
    }

    /* LOADING BANNER (oben, ohne Rundungen, keine L√ºcke) */
    .loadingBanner{
      position: fixed;
      left:0; right:0; top:0;
      padding-top: var(--safe-top);
      height: calc(34px + var(--safe-top));
      display:flex;
      align-items:flex-end;
      justify-content:center;
      background: rgba(0,0,0,.72);
      backdrop-filter: blur(8px);
      z-index: 9999;
      border-radius: 0;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      user-select:none;
    }
    .loadingBanner .txt{
      padding: 0 12px 8px;
      letter-spacing: .22em;
      font-size: 12px;
      opacity: .92;
      text-transform: uppercase;
    }
    .loadingBanner .dots::after{
      content:"";
      display:inline-block;
      width: 18px;
      text-align:left;
      animation: dots 1.1s steps(4, end) infinite;
    }
    @keyframes dots{
      0%{ content:""; }
      25%{ content:"."; }
      50%{ content:".."; }
      75%{ content:"..."; }
      100%{ content:""; }
    }
    .loadingBanner.hide{
      opacity:0;
      pointer-events:none;
      transition: opacity .25s ease;
    }

    .page{
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
    }

    .stage{
      position:relative;
      width:100%;
      max-width: 860px;
      padding-top: calc(8px + var(--safe-top));
      padding-bottom: 16px;
      display:flex;
      justify-content:center;
      align-items:center;
    }

    .panelShell{
      position:relative;
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      background:#000; /* schwarze ‚ÄúBalken‚Äù-Fl√§che um das Panel herum */
    }

    .panelImg{
      width: min(100vw, 860px);
      height: auto;
      display:block;
      background:#000;
    }

    .playerDock{
      position:absolute;
      left:50%;
      bottom: var(--dock-overlap);
      transform: translateX(-50%);
      z-index:20;
    }

    .player{
      position:relative;
      width:78px;
      height:78px;
      border-radius:999px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
      transition: width .28s ease, height .28s ease, border-radius .28s ease;
    }

    .player .embedWrap{ display:none; }

    .playerBtn{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      position:relative;
      z-index: 6; /* IMMER √ºber iframe */
      touch-action: manipulation;
      -webkit-user-select:none;
      user-select:none;
    }

    .playIcon{
      width:0;
      height:0;
      border-top:12px solid transparent;
      border-bottom:12px solid transparent;
      border-left:18px solid rgba(255,255,255,.92);
      transform: translateX(2px);
    }

    .player.expanded{
      width: var(--player-expanded-w);
      height: var(--player-expanded-h);
      border-radius:22px;
      background: rgba(255,255,255,.12);
    }

    .player.expanded .embedWrap{ display:block; }

    .player.expanded .playerBtn{
      position:absolute;
      left:10px;
      top:10px;
      width:54px;
      height:54px;
      border-radius:999px;
      background: rgba(0,0,0,.26);
      border:1px solid rgba(255,255,255,.18);
    }

    .embedWrap{
      position:absolute;
      inset:10px;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.10);
      z-index: 1; /* unter dem Button */
    }

    .embedWrap iframe{
      width:100%;
      height:100%;
      border:0;
    }

    /* üîí MASKIERT den linken SoundCloud-Playbutton NUR wenn expanded */
    .player.expanded::before{
      content:"";
      position:absolute;
      left:10px;
      top:10px;
      bottom:10px;
      width: var(--sc-left-mask-w);
      background: rgba(0,0,0,.35);
      backdrop-filter: blur(6px);
      border-radius:14px;
      z-index:4;
      pointer-events:none;
    }
  </style>
</head>

<body>

<div id="loadingBanner" class="loadingBanner" aria-hidden="true">
  <div class="txt">LOADING<span class="dots"></span></div>
</div>

<div class="page">
  <div class="stage">
    <div class="panelShell">
      <img id="panelImg" class="panelImg" src="./manga/chapter-00/panel01.jpg" alt="Panel 01">

      <div class="playerDock">
        <div id="player" class="player" aria-label="Audio Player">
          <div id="playerBtn" class="playerBtn" role="button" tabindex="0" aria-label="Play / Pause">
            <div class="playIcon"></div>
          </div>

          <div class="embedWrap">
            <iframe
              id="scFrame"
              allow="autoplay"
              scrolling="no"
              src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/user-543596862/sentinel-2&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false&visual=false">
            </iframe>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script src="https://w.soundcloud.com/player/api.js"></script>
<script>
(() => {
  const player = document.getElementById("player");
  const btn = document.getElementById("playerBtn");
  const frame = document.getElementById("scFrame");
  const img = document.getElementById("panelImg");
  const banner = document.getElementById("loadingBanner");

  let widget = SC.Widget(frame);
  let scReady = false;
  let playing = false;
  let pendingPlay = false;
  let imgReady = false;

  const hideBannerIfReady = () => {
    if (imgReady && scReady) banner.classList.add("hide");
  };

  // Bild geladen?
  if (img.complete) {
    imgReady = true;
    hideBannerIfReady();
  } else {
    img.addEventListener("load", () => { imgReady = true; hideBannerIfReady(); }, { once:true });
    img.addEventListener("error", () => { imgReady = true; hideBannerIfReady(); }, { once:true });
  }

  // SoundCloud ready?
  widget.bind(SC.Widget.Events.READY, () => {
    scReady = true;
    hideBannerIfReady();
    if (pendingPlay) {
      pendingPlay = false;
      widget.play();
    }
  });

  widget.bind(SC.Widget.Events.PLAY, () => playing = true);
  widget.bind(SC.Widget.Events.PAUSE, () => playing = false);
  widget.bind(SC.Widget.Events.FINISH, () => {
    playing = false;
    player.classList.remove("expanded");
  });

  const doPlay = () => {
    if (scReady) widget.play();
    else pendingPlay = true;
  };

  const toggle = (ev) => {
    ev.preventDefault();
    ev.stopPropagation();

    if (!player.classList.contains("expanded")) {
      player.classList.add("expanded");
      doPlay(); // 1. Klick = expand + play (User-Geste)
      return;
    }
    playing ? widget.pause() : widget.play(); // im expanded: pause/play
  };

  btn.addEventListener("click", toggle, { passive:false });
  btn.addEventListener("touchend", toggle, { passive:false });
  btn.addEventListener("keydown", (e) => {
    if (e.key === "Enter" || e.key === " ") toggle(e);
  });

  // Klick au√üerhalb klappt zu (optional, aber stabil & praktisch)
  document.addEventListener("pointerdown", (e) => {
    if (!player.classList.contains("expanded")) return;
    if (player.contains(e.target)) return;
    player.classList.remove("expanded");
    if (playing) widget.pause();
  }, { passive:true });
})();
</script>

</body>
</html>