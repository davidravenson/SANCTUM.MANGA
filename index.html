<script>
  // ===== Pfade anpassen =====
  const IMG_SRC   = "./manga/my-series/chapter-1/001.jpg?v=3";
  const AUDIO_SRC = "./audio/sanctum_ch1_arcangel_instrumental.mp3?v=3";

  // ===== Fade / Lautstaerke =====
  const FADE_MS = 2500;
  const TARGET_VOL_DEFAULT = 0.45;

  const img   = document.getElementById("panelImg");
  const audio = document.getElementById("bgAudio");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const vol      = document.getElementById("vol");
  const status   = document.getElementById("status");
  const panel    = document.getElementById("panel");

  img.src = IMG_SRC;

  // Audio Setup
  audio.src = AUDIO_SRC;
  audio.preload = "auto";
  audio.loop = true;
  audio.playsInline = true;

  function setStatus(t){ if (status) status.textContent = t; }

  // Soft barrier gegen "Speichern unter"
  document.addEventListener("contextmenu", e => e.preventDefault());

  let fadeRAF = null;
  function fadeTo(target, ms){
    if (fadeRAF) cancelAnimationFrame(fadeRAF);
    const start = performance.now();
    const from = audio.volume;
    const delta = target - from;

    function step(now){
      const p = Math.min(1, (now - start) / ms);
      audio.volume = from + delta * p;
      if (p < 1) fadeRAF = requestAnimationFrame(step);
    }
    fadeRAF = requestAnimationFrame(step);
  }

  async function startWithFade(){
    const target = Math.max(0, Math.min(1, parseFloat(vol.value) || TARGET_VOL_DEFAULT));

    try{
      // wichtig auf Android: erst laden, dann play
      audio.pause();
      audio.currentTime = Math.max(0, audio.currentTime || 0);
      audio.volume = 0;
      audio.muted = false;

      // force reload attempt (helps if src changed / cached weird)
      audio.load();

      const p = audio.play();
      if (p && typeof p.then === "function") await p;

      setStatus("läuft…");
      fadeTo(target, FADE_MS);
    } catch (e){
      // Zeig den Fehler an (super hilfreich)
      setStatus("Audio blockiert: " + (e?.name || "Error"));
      console.log("Audio play error:", e);
    }
  }

  function pauseAudio(){
    audio.pause();
    setStatus("pausiert");
  }

  // moderate Default
  vol.value = TARGET_VOL_DEFAULT.toFixed(2);
  audio.volume = 0;

  // Lautstärke-Regler
  vol.addEventListener("input", () => {
    const v = Math.max(0, Math.min(1, parseFloat(vol.value)));
    if (!audio.paused) fadeTo(v, 200);
    else audio.volume = v;
  });

  // Android: pointerdown ist zuverlässiger als click
  btnStart.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    startWithFade();
  }, { passive: false });

  btnPause.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    pauseAudio();
  }, { passive: false });

  // Tap aufs Panel startet auch
  panel.addEventListener("pointerdown", () => {
    if (audio.paused) startWithFade();
  }, { passive: true });

  // Autoplay nur "versuchen" — wenn blockiert, egal
  window.addEventListener("load", () => {
    setStatus("bereit");
    // Versuch, aber keine Erwartung: Android blockt oft
    startWithFade();
  });

  // Debug-Events (hilft bei "läuft nicht" schnell)
  audio.addEventListener("playing", () => setStatus("läuft…"));
  audio.addEventListener("pause",   () => setStatus("pausiert"));
  audio.addEventListener("waiting", () => setStatus("lädt…"));
  audio.addEventListener("error",   () => setStatus("Audio-Fehler"));

</script>