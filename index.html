<script>
  const IMG_SRC = "./manga/my-series/chapter-1/001.jpg?v=9";

  // Dateiname exakt wie im audio-Ordner:
  const AUDIO_FILE = "sanctum_ch1_arcangel_instrumental.mp3";

  const FADE_MS = 2500;
  const TARGET_VOL_DEFAULT = 0.45;

  const img   = document.getElementById("panelImg");
  const audio = document.getElementById("bgAudio");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const vol      = document.getElementById("vol");
  const status   = document.getElementById("status");
  const panel    = document.getElementById("panel");

  img.src = IMG_SRC;

  function setStatus(t){ if (status) status.textContent = t; }

  document.addEventListener("contextmenu", e => e.preventDefault());

  // Kandidaten (funktioniert je nach dem, ob index.html im Root oder in Unterordnern liegt)
  const candidates = [
    new URL("./audio/" + AUDIO_FILE, document.baseURI).href,      // neben index.html
    new URL("/audio/" + AUDIO_FILE, location.origin).href,        // Root der Domain
    new URL("/SANCTUM.MANGA/audio/" + AUDIO_FILE, location.origin).href // Projekt-Repo Pages
  ];

  async function pickFirstWorkingUrl(urls){
    for (const u of urls){
      try{
        const r = await fetch(u, { method: "HEAD", cache: "no-store" });
        if (r.ok) return u;
      }catch(_){}
    }
    return null;
  }

  let fadeRAF = null;
  function fadeTo(target, ms){
    if (fadeRAF) cancelAnimationFrame(fadeRAF);
    const start = performance.now();
    const from = audio.volume;
    const delta = target - from;

    function step(now){
      const p = Math.min(1, (now - start) / ms);
      audio.volume = from + delta * p;
      if (p < 1) fadeRAF = requestAnimationFrame(step);
    }
    fadeRAF = requestAnimationFrame(step);
  }

  async function ensureAudioSrc(){
    if (audio.src) return true;

    setStatus("suche audio…");
    const chosen = await pickFirstWorkingUrl(candidates);

    if (!chosen){
      setStatus("Audio-Pfad nicht gefunden");
      console.log("Audio candidates failed:", candidates);
      return false;
    }

    audio.src = chosen + "?v=9";
    audio.preload = "auto";
    audio.loop = true;
    audio.playsInline = true;

    setStatus("audio bereit");
    console.log("Audio chosen:", audio.src);
    return true;
  }

  async function startWithFade(){
    const ok = await ensureAudioSrc();
    if (!ok) return;

    const target = Math.max(0, Math.min(1, parseFloat(vol.value) || TARGET_VOL_DEFAULT));

    try{
      audio.volume = 0;
      audio.muted = false;
      audio.load();

      await audio.play();
      setStatus("läuft…");
      fadeTo(target, FADE_MS);
    }catch(e){
      setStatus("blockiert: " + (e?.name || "Error"));
      console.log("Audio play error:", e);
    }
  }

  function pauseAudio(){
    audio.pause();
    setStatus("pausiert");
  }

  vol.value = TARGET_VOL_DEFAULT.toFixed(2);

  vol.addEventListener("input", () => {
    const v = Math.max(0, Math.min(1, parseFloat(vol.value)));
    if (!audio.paused) fadeTo(v, 200);
    else audio.volume = v;
  });

  // Android: pointerdown > click
  btnStart.addEventListener("pointerdown", (e) => { e.preventDefault(); startWithFade(); }, { passive:false });
  btnPause.addEventListener("pointerdown", (e) => { e.preventDefault(); pauseAudio(); }, { passive:false });
  panel.addEventListener("pointerdown", () => { if (audio.paused) startWithFade(); }, { passive:true });

  // Autostart versuchen (kann blockiert werden)
  window.addEventListener("load", () => {
    setStatus("bereit");
    startWithFade();
  });
</script>