<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>SANCTUM — Reader</title>

<style>
:root{
  --v:"v0.29.5";
  --safe-top:env(safe-area-inset-top,0px);
  --safe-bottom:env(safe-area-inset-bottom,0px);
  --bg:url("./media/ui/manga_paper_bg.png");
  --shadow:0 16px 40px rgba(0,0,0,.35);
}

html,body{
  margin:0;
  height:100%;
  background:#000;
  color:#fff;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  overflow-x:hidden;
  -webkit-tap-highlight-color:transparent;
}

/* Cross-browser viewport stability */
body{
  min-height:100vh;
  min-height:100svh;
  min-height:100dvh;
  background-image:var(--bg);
  background-size:cover;
  background-position:center top;
  background-repeat:no-repeat;
  background-attachment:fixed;
  overscroll-behavior:none;
  touch-action:pan-y;
}

/* iOS Safari background-attachment fix */
html.ios body{ background-attachment:scroll; }

/* Blur fallbacks (no design change, just stability) */
@supports not ((backdrop-filter: blur(1px)) or (-webkit-backdrop-filter: blur(1px))){
  .player{ background: rgba(255,255,255,.14) !important; }
  .loading::before{ background: rgba(0,0,0,.18) !important; }
}

.page{
  min-height:100vh;
  min-height:100svh;
  min-height:100dvh;
  display:flex;
  flex-direction:column;
  align-items:center;
}

.stage{
  width:100%;
  max-width:860px;
  padding-top:var(--safe-top);
  position:relative;
  display:flex;
  justify-content:center;
}

.panelShell{
  position:relative;
  width:100%;
}

.panelImg{
  width:100%;
  display:block;
  background:#000;
  user-select:none;
  -webkit-user-select:none;
  -webkit-user-drag:none;
}

/* PLAYER DOCK */
.playerDock{
  position:absolute;
  left:50%;
  bottom:-26px;
  transform:translateX(-50%);
  z-index:20;
  transition:transform .25s ease;
  will-change:transform;
}
.playerDock.shiftDown{
  transform:translateX(-50%) translateY(200px);
}

/* PLAYER */
.player{
  position:relative;
  width:78px;
  height:78px;
  border-radius:999px;
  background:rgba(255,255,255,.10);
  border:1px solid rgba(255,255,255,.18);
  box-shadow:var(--shadow);
  backdrop-filter:blur(10px);
  -webkit-backdrop-filter:blur(10px);
  overflow:hidden;
  transition:width .28s ease,height .28s ease,border-radius .28s ease;
}

/* collapsed */
.player .meta,
.player .embedWrap,
.player .openBtn,
.player .closeBtn{display:none;}

.playerBtn{
  width:100%;
  height:100%;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}

.playIcon{
  width:0;height:0;
  border-top:12px solid transparent;
  border-bottom:12px solid transparent;
  border-left:18px solid rgba(0,0,0,.92);
  transform:translateX(2px);
}

/* expanded */
.player.expanded{
  width:min(92vw,640px);
  height:240px;
  border-radius:22px;
  background:rgba(255,255,255,.12);
}

.player.expanded .meta,
.player.expanded .embedWrap,
.player.expanded .openBtn,
.player.expanded .closeBtn{display:block;}

.player.expanded .playerBtn{display:none;}

/* META TOPBAR */
.meta{
  position:absolute;
  left:12px;
  right:12px;
  top:12px;
  display:flex;
  align-items:center;
  gap:12px;
  background:rgba(255,255,255,.75);
  border-radius:18px;
  padding:10px 14px;
  box-shadow:0 10px 18px rgba(0,0,0,.18);
  min-width:0;
}

.metaText{
  display:flex;
  flex-direction:column;
  min-width:0;
  flex:1;
  line-height:1.05;
}

.metaText .t{
  font-weight:900;
  font-size:18px;
  letter-spacing:.03em;
  color:#0d0d0d;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.metaText .a{
  margin-top:2px;
  font-weight:700;
  font-size:13px;
  color:#0d0d0d;
  opacity:.9;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}

.metaActions{
  display:flex;
  align-items:center;
  gap:8px;
  flex-shrink:0;
}

.openBtn{
  padding:10px 12px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(0,0,0,.18);
  color:#fff;
  font-weight:700;
  font-size:13px;
  text-decoration:none;
  white-space:nowrap;
}

.closeBtn{
  width:36px;
  height:36px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.22);
  background:rgba(0,0,0,.18);
  color:#fff;
  font-weight:900;
  font-size:18px;
  line-height:34px;
  text-align:center;
  cursor:pointer;
  user-select:none;
}

/* embed */
.embedWrap{
  position:absolute;
  left:10px;
  right:10px;
  bottom:10px;
  top:82px;
  border-radius:18px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(255,255,255,.10);
}
.embedWrap iframe{
  width:100%;
  height:100%;
  border:0;
}

/* LOADING */
.loading{
  position:fixed;
  inset:0;
  z-index:9999;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding-top:var(--safe-top);
  background:rgba(0,0,0,.08);
  transition:opacity .35s ease;
}
.loading::before{
  content:"";
  position:absolute;
  inset:0;
  backdrop-filter:blur(14px);
  -webkit-backdrop-filter:blur(14px);
  background:rgba(0,0,0,.10);
}
.coverBanner{
  width:min(92vw,520px);
  box-shadow:0 30px 70px rgba(0,0,0,.55);
}
.coverBanner img{width:100%;display:block;}

.bottomSpacer{height:360px;}
</style>
</head>

<body>

<div id="loading" class="loading" aria-hidden="false">
  <div class="coverBanner">
    <img id="coverImg" src="./manga/chapter-00/cover.jpg" alt="SANCTUM cover">
  </div>
</div>

<div class="page">
  <div class="stage">
    <div class="panelShell">
      <img id="panelImg" class="panelImg" src="./manga/chapter-00/panel01.jpg" alt="Panel 01">

      <div id="playerDock" class="playerDock">
        <div id="player" class="player">

          <div id="playerBtn" class="playerBtn" aria-label="Play">
            <div class="playIcon" aria-hidden="true"></div>
          </div>

          <div class="meta">
            <div class="metaText">
              <div class="t">SENTINEL</div>
              <div class="a">DAVID RAVENSON</div>
            </div>
            <div class="metaActions">
              <a class="openBtn"
                 href="https://soundcloud.com/user-543596862/sentinel-2"
                 target="_blank" rel="noopener noreferrer">SoundCloud</a>
              <div id="closeBtn" class="closeBtn" aria-label="Close">×</div>
            </div>
          </div>

          <div class="embedWrap">
            <iframe id="scFrame"
              allow="autoplay"
              scrolling="no"
              src="https://w.soundcloud.com/player/?url=https%3A//soundcloud.com/user-543596862/sentinel-2&auto_play=false&hide_related=true&show_comments=false&show_user=true&show_reposts=false&show_teaser=false">
            </iframe>
          </div>

        </div>
      </div>

    </div>
  </div>

  <div class="bottomSpacer"></div>
</div>

<script src="https://w.soundcloud.com/player/api.js"></script>
<script>
(function(){
  const ua = navigator.userAgent || "";
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
  if(isIOS) document.documentElement.classList.add("ios");

  const loading = document.getElementById("loading");
  const panel   = document.getElementById("panelImg");
  const cover   = document.getElementById("coverImg");

  const player  = document.getElementById("player");
  const btn     = document.getElementById("playerBtn");
  const close   = document.getElementById("closeBtn");
  const dock    = document.getElementById("playerDock");

  const frame   = document.getElementById("scFrame");

  function hideLoader(){
    if(!loading) return;
    loading.style.opacity = "0";
    loading.setAttribute("aria-hidden","true");
    setTimeout(()=>{ loading.remove(); }, 420);
  }

  function isImageComplete(img){
    return img && img.complete && img.naturalWidth > 0;
  }

  // loader reliability
  const beat = 600;
  if(isImageComplete(panel)) setTimeout(hideLoader, beat);
  else{
    panel.addEventListener("load", ()=>setTimeout(hideLoader, beat), {passive:true});
    panel.addEventListener("error", ()=>setTimeout(hideLoader, beat), {passive:true});
  }
  if(cover) cover.addEventListener("error", ()=>{}, {passive:true});

  // ---- SOUND CLOUD READY HARDENING ----
  let widget = null;
  let widgetReady = false;
  let pendingPlay = false;

  function bindWidget(w){
    widget = w;
    try{
      widget.bind(SC.Widget.Events.READY, function(){
        widgetReady = true;
        if(pendingPlay){
          pendingPlay = false;
          try{ widget.play(); }catch(_){}
        }
      });
    }catch(_){}
  }

  // Try to create widget even if SC loads a bit late
  function initWidgetWithRetry(){
    const start = Date.now();
    const timer = setInterval(()=>{
      if(window.SC && window.SC.Widget && frame){
        clearInterval(timer);
        try{
          bindWidget(SC.Widget(frame));
        }catch(_){}
      }
      // stop after ~4 seconds
      if(Date.now() - start > 4000){
        clearInterval(timer);
      }
    }, 80);
  }
  initWidgetWithRetry();

  // Player button: expand + guaranteed play as soon as READY exists
  btn.addEventListener("click",(e)=>{
    e.preventDefault();
    e.stopPropagation();

    player.classList.add("expanded");
    dock.classList.remove("shiftDown");

    pendingPlay = true;

    // If already ready, play immediately (same user gesture)
    if(widget && widgetReady){
      pendingPlay = false;
      try{ widget.play(); }catch(_){}
    }else if(widget){
      // attempt anyway; if it fails, READY handler will replay
      try{ widget.play(); }catch(_){}
    }
  }, {passive:false});

  close.addEventListener("click",(e)=>{
    e.preventDefault();
    e.stopPropagation();
    pendingPlay = false;
    if(widget){
      try{ widget.pause(); }catch(_){}
    }
    player.classList.remove("expanded");
    dock.classList.remove("shiftDown");
  }, {passive:false});

  // Panel tap: if expanded, shift down 200px (unchanged)
  panel.addEventListener("click",()=>{
    if(player.classList.contains("expanded")){
      dock.classList.toggle("shiftDown");
    }
  }, {passive:true});
})();
</script>

</body>
</html>