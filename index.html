<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SANCTUM — Pilot</title>

  <style>
    :root{
      --version: "v0.27";
      --paper-bg: url("./media/ui/manga_paper_bg.png");
      --ui-bg: rgba(255,255,255,0.78);
      --ui-border: rgba(0,0,0,0.12);
      --ui-shadow: 0 8px 24px rgba(0,0,0,0.18);
      --ink: #111;
    }

    html,body{
      height:100%;
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:#000;
      overscroll-behavior-y:auto; /* pull-to-refresh nicht absägen */
    }

    /* Papier + dunkler Himmel (oben) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      z-index:-2;
      background:
        radial-gradient(1200px 520px at 50% -120px, rgba(0,0,0,0.92), rgba(0,0,0,0.85) 40%, rgba(0,0,0,0.25) 68%, rgba(0,0,0,0.00) 78%),
        var(--paper-bg);
      background-size: cover, cover;
      background-position: top center, center;
      background-repeat:no-repeat, no-repeat;
    }

    /* dezente Sternchen oben (sehr fein) */
    body::after{
      content:"";
      position:fixed;
      inset:0;
      z-index:-1;
      pointer-events:none;
      background-image:
        radial-gradient(circle at 12% 10%, rgba(255,255,255,0.9) 0 1px, transparent 2px),
        radial-gradient(circle at 78% 12%, rgba(255,255,255,0.7) 0 1px, transparent 2px),
        radial-gradient(circle at 40% 20%, rgba(255,255,255,0.5) 0 1px, transparent 2px),
        radial-gradient(circle at 62% 28%, rgba(255,255,255,0.35) 0 1px, transparent 2px);
      opacity:0.35;
    }

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-start;
      padding:12px 12px calc(92px + env(safe-area-inset-bottom));
      box-sizing:border-box;
      gap:10px;
    }

    /* PANEL CARD */
    .panelCard{
      width:100%;
      max-width:980px;
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 18px;
      box-shadow: var(--ui-shadow);
      overflow:hidden;
    }

    .panelArea{
      width:100%;
      touch-action: pan-y pinch-zoom;
      user-select:none;
      -webkit-user-select:none;
      background: rgba(0,0,0,0.08);
    }

    .panelArea img{
      width:100%;
      height:auto;
      display:block;
      background:#fff;
    }

    /* HUD (kurz sichtbar, nicht dauerhaft im Weg) */
    .hud{
      position:fixed;
      left:12px;
      bottom: calc(92px + env(safe-area-inset-bottom));
      z-index:20;
      max-width: 86vw;
      background: rgba(30,30,30,0.68);
      color:#fff;
      padding:10px 12px;
      border-radius:14px;
      font-size:14px;
      opacity:0;
      transform: translateY(6px);
      transition: opacity 200ms ease, transform 200ms ease;
      pointer-events:none;
      white-space:pre-line;
    }
    .hud.show{
      opacity:1;
      transform: translateY(0);
    }

    /* Minimal Trackbar */
    .trackbar{
      width:100%;
      max-width:980px;
      background: var(--ui-bg);
      border:1px solid var(--ui-border);
      border-radius:18px;
      box-shadow: var(--ui-shadow);
      overflow:hidden;
    }

    .trackHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px 8px;
      color:var(--ink);
    }

    .trackText{
      line-height:1.05;
    }

    .trackTitle{
      font-weight:800;
      letter-spacing:0.4px;
      font-size:18px;
    }

    .trackArtist{
      margin-top:4px;
      opacity:0.85;
      font-size:14px;
      font-weight:600;
    }

    .scBtn{
      flex:0 0 auto;
      align-self:center;
      border:1px solid rgba(0,0,0,0.10);
      background: rgba(255,255,255,0.75);
      padding:10px 12px;
      border-radius:14px;
      font-weight:700;
      color:#111;
      text-decoration:none;
      display:inline-block;
    }

    .scEmbed{
      width:100%;
      height:110px;
      border:0;
      display:block;
      background:#fff;
    }

    /* Maintenance bar sticky bottom */
    .maintenance{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      z-index:30;
      padding:8px 10px calc(8px + env(safe-area-inset-bottom));
      display:flex;
      justify-content:center;
      pointer-events:none; /* nicht klicken im Weg */
    }

    .maintenanceInner{
      width:min(980px, 96vw);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(0,0,0,0.36);
      color: rgba(255,255,255,0.85);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 16px;
      padding:8px 10px;
      font-size:12px;
      backdrop-filter: blur(6px);
    }

    .maintLeft{ opacity:0.9; }
    .maintRight{ opacity:0.85; }
    .maintRight code{ opacity:0.95; }

    /* LOADER (Cover Screen) */
    .loader{
      position:fixed;
      inset:0;
      z-index:999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      box-sizing:border-box;
      background:
        radial-gradient(1200px 520px at 50% -120px, rgba(0,0,0,0.95), rgba(0,0,0,0.86) 42%, rgba(0,0,0,0.35) 72%, rgba(0,0,0,0.00) 84%),
        var(--paper-bg);
      background-size: cover, cover;
      background-position: top center, center;
      background-repeat:no-repeat, no-repeat;
      transition: opacity 260ms ease;
      opacity:1;
    }

    .loader.hide{
      opacity:0;
      pointer-events:none;
    }

    .coverBox{
      width:min(520px, 88vw);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,0.62);
      border:1px solid rgba(0,0,0,0.10);
      box-shadow: var(--ui-shadow);
    }

    .coverImg{
      width:100%;
      height:auto;
      display:block;
      background: transparent;
    }

    .coverFallback{
      padding:14px 14px 16px;
      color:#111;
      font-weight:800;
      letter-spacing:0.4px;
    }
  </style>
</head>

<body>

  <!-- LOADING / COVER -->
  <div class="loader" id="loader">
    <div class="coverBox">
      <img id="coverImg" class="coverImg" alt="SANCTUM Cover" />
      <div id="coverFallback" class="coverFallback" style="display:none;">
        SANCTUM — Loading…
      </div>
    </div>
  </div>

  <div class="wrap">

    <div class="panelCard">
      <div class="panelArea" id="panelArea">
        <img id="panelImg" alt="SANCTUM Panel" />
      </div>
    </div>

    <div class="trackbar">
      <div class="trackHead">
        <div class="trackText">
          <div class="trackTitle">SENTINEL</div>
          <div class="trackArtist">DAVID RAVENSON</div>
        </div>
        <a class="scBtn" id="openSc" href="https://soundcloud.com/user-543596862/sentinel-2" target="_blank" rel="noopener">
          Open on SoundCloud
        </a>
      </div>

      <!-- SoundCloud embed (streaming, kein mp3-download) -->
      <iframe
        class="scEmbed"
        id="scEmbed"
        scrolling="no"
        allow="autoplay"
        src=""
        title="SoundCloud Player">
      </iframe>
    </div>

  </div>

  <div class="hud" id="hud"></div>

  <div class="maintenance">
    <div class="maintenanceInner">
      <div class="maintLeft" id="maintLeft"></div>
      <div class="maintRight" id="maintRight"></div>
    </div>
  </div>

  <script>
    // =========================
    // VERSION
    // =========================
    const VERSION = "v0.27";

    // =========================
    // CONFIG (Kapitel / Panels)
    // =========================
    // Panels: manga/chapter-00/panel01.jpg ...
    // Cover:  manga/chapter-00/cover.jpg
    const DEFAULT_CHAPTER = "chapter-00";
    const TOTAL_PANELS = 20;

    const pad2 = (n) => String(n).padStart(2, "0");
    const panelPath = (chapter, index1based) => `./manga/${chapter}/panel${pad2(index1based)}.jpg`;
    const coverPath = (chapter) => `./manga/${chapter}/cover.jpg`;

    // =========================
    // ELEMENTS
    // =========================
    const loader = document.getElementById("loader");
    const coverImg = document.getElementById("coverImg");
    const coverFallback = document.getElementById("coverFallback");

    const panelArea = document.getElementById("panelArea");
    const panelImg = document.getElementById("panelImg");
    const hud = document.getElementById("hud");

    const maintLeft = document.getElementById("maintLeft");
    const maintRight = document.getElementById("maintRight");

    const scEmbed = document.getElementById("scEmbed");

    // =========================
    // HUD show helper (auto hide)
    // =========================
    let hudTimer = null;
    function showHud(text, ms=1000){
      hud.textContent = text;
      hud.classList.add("show");
      if (hudTimer) clearTimeout(hudTimer);
      hudTimer = setTimeout(()=>hud.classList.remove("show"), ms);
    }

    // =========================
    // ROUTER (hash)
    // #chapter-00/cover
    // #chapter-00/01
    // =========================
    function parseHash(){
      const raw = (location.hash || "").replace(/^#/, "").trim();
      if (!raw) return { chapter: DEFAULT_CHAPTER, mode: "panel", panel: 1 };

      const parts = raw.split("/");
      const chapter = parts[0] || DEFAULT_CHAPTER;
      const second = (parts[1] || "").toLowerCase();

      if (second === "cover") return { chapter, mode: "cover", panel: 1 };

      // panel number
      const n = Number(second);
      if (Number.isFinite(n) && n >= 1) return { chapter, mode: "panel", panel: Math.min(n, TOTAL_PANELS) };

      return { chapter, mode: "panel", panel: 1 };
    }

    function setHash(chapter, panel){
      location.hash = `#${chapter}/${pad2(panel)}`;
    }

    // =========================
    // SOUNDCLOUD EMBED
    // =========================
    const SC_TRACK_URL = "https://soundcloud.com/user-543596862/sentinel-2";
    function setSoundCloud(){
      const encoded = encodeURIComponent(SC_TRACK_URL);
      // minimal player; still shows waveform but smaller footprint
      scEmbed.src = `https://w.soundcloud.com/player/?url=${encoded}&auto_play=false&hide_related=true&show_comments=false&show_user=false&show_reposts=false&visual=false`;
    }

    // =========================
    // LOADER (Cover screen)
    // - shows cover image if it exists
    // - hides after a minimum time + once first panel loaded
    // =========================
    let loaderMinDone = false;
    let panelLoaded = false;
    let loaderHidden = false;

    function tryHideLoader(){
      if (loaderHidden) return;
      if (!loaderMinDone) return;
      if (!panelLoaded) return;

      loaderHidden = true;
      loader.classList.add("hide");
      setTimeout(()=>{ loader.style.display = "none"; }, 320);
    }

    function showLoaderForChapter(chapter){
      loader.style.display = "flex";
      loader.classList.remove("hide");
      loaderHidden = false;
      panelLoaded = false;
      loaderMinDone = false;

      // Minimum show time to feel intentional (nicht “blip”)
      setTimeout(()=>{ loaderMinDone = true; tryHideLoader(); }, 900);

      // Load cover image (if missing, show fallback text)
      coverFallback.style.display = "none";
      coverImg.style.display = "block";

      const url = coverPath(chapter) + `?v=${encodeURIComponent(VERSION)}`;
      coverImg.src = url;

      coverImg.onload = () => {
        // nice, nothing else
      };
      coverImg.onerror = () => {
        // cover not found -> show text instead of tiny alt-label
        coverImg.style.display = "none";
        coverFallback.style.display = "block";
        showHud("Cover nicht gefunden.\nLege cover.jpg in manga/"+chapter+"/", 1400);
      };
    }

    // =========================
    // PANEL RENDER
    // =========================
    let state = parseHash();
    function renderPanel(chapter, panelIndex){
      const url = panelPath(chapter, panelIndex) + `?v=${encodeURIComponent(VERSION)}`;
      panelImg.src = url;

      maintLeft.textContent = `SENTINEL • DAVID RAVENSON`;
      maintRight.innerHTML = `<code>${VERSION}</code> • ${chapter} • panel ${pad2(panelIndex)}`;

      showHud(`Ready.\nSwipe right to continue.`, 1000);
    }

    panelImg.onload = () => {
      panelLoaded = true;
      tryHideLoader();
    };

    panelImg.onerror = () => {
      panelLoaded = true; // don't softlock loader
      tryHideLoader();
      showHud("Panel fehlt.\nPrüfe: manga/"+state.chapter+"/panel"+pad2(state.panel)+".jpg", 1800);
    };

    // =========================
    // SWIPE (rechts = weiter)
    // =========================
    let startX=0, startY=0, startT=0;
    let isPinching=false, isSwiping=false;

    panelArea.addEventListener("touchstart", (e)=>{
      if (e.touches.length >= 2){ isPinching=true; isSwiping=false; return; }
      isPinching=false; isSwiping=true;
      const t = e.touches[0];
      startX=t.clientX; startY=t.clientY; startT=Date.now();
    }, {passive:true});

    panelArea.addEventListener("touchend", (e)=>{
      if (!isSwiping || isPinching) return;
      const t = e.changedTouches[0];
      const dx = t.clientX - startX;
      const dy = t.clientY - startY;
      const dt = Date.now() - startT;

      if (Math.abs(dx) > 40 && Math.abs(dx) > Math.abs(dy) * 1.2 && dt < 700) {
        // Swipe RIGHT => NEXT
        if (dx > 0) nextPanel();
        else prevPanel();
      }
    }, {passive:true});

    function nextPanel(){
      if (state.panel < TOTAL_PANELS) state.panel++;
      setHash(state.chapter, state.panel);
      renderPanel(state.chapter, state.panel);
    }
    function prevPanel(){
      if (state.panel > 1) state.panel--;
      setHash(state.chapter, state.panel);
      renderPanel(state.chapter, state.panel);
    }

    // =========================
    // INIT / HASH CHANGE
    // =========================
    function applyRoute(){
      state = parseHash();

      setSoundCloud();

      // immer kurz Cover-Ladescreen zeigen (aber nicht als “eigene Seite” festklemmen)
      showLoaderForChapter(state.chapter);

      // wenn jemand direkt /cover im hash hat, starten wir trotzdem bei panel 1 danach
      if (state.mode === "cover"){
        state.panel = 1;
        // hash sauber setzen, damit du nicht auf /cover “hängst”
        setHash(state.chapter, state.panel);
      }

      renderPanel(state.chapter, state.panel);
    }

    window.addEventListener("hashchange", applyRoute);

    // Start
    applyRoute();
  </script>
</body>
</html>